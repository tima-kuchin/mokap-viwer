<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR-модель ручки с логотипом</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    #controls { position: absolute; top: 10px; left: 10px; z-index: 1; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; }
    #logo-upload, #color-picker { display: block; margin-bottom: 10px; }
    #ar-container { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="logo-upload">Загрузить логотип (PNG):</label>
    <input type="file" id="logo-upload" accept="image/png">
    <label for="color-picker">Выберите цвет корпуса:</label>
    <select id="color-picker">
      <option value="#FF0000">Красный</option>
      <option value="#FF7F00">Оранжевый</option>
      <option value="#FFFF00">Жёлтый</option>
      <option value="#00FF00">Зелёный</option>
      <option value="#0000FF">Синий</option>
      <option value="#4B0082">Индиго</option>
      <option value="#8B00FF">Фиолетовый</option>
    </select>
  </div>
  <div id="ar-container"></div>

  <!-- Three.js и модули -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/examples/jsm/webxr/ARButton.js"></script>

  <script>
    let scene, camera, renderer, controller;
    let reticle, penModel, targetMesh;

    // Offscreen canvas для генерации текстуры 2048x2048
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 2048;
    canvas.height = 2048;
    let logoImg = null;
    let baseColor = '#3a8ac7';

    function initCanvas() {
      // Заливка корпуса цветом
      ctx.fillStyle = baseColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // Рисуем логотип, если загружен
      if (logoImg) drawLogo();
    }

    function drawLogo() {
      // Позиция в пикселях: справа-налево 215-350px, сверху-вниз 512-1250px
      const xStart = canvas.width - 350;      // 2048 - 350 = 1698
      const yStart = 512;
      const width = 350 - 215;               // 135px
      const height = 1250 - 512;             // 738px
      ctx.clearRect(xStart, yStart, width, height);
      ctx.drawImage(logoImg, xStart, yStart, width, height);
    }

    function updateTexture() {
      if (!targetMesh) return;
      const texture = new THREE.CanvasTexture(canvas);
      texture.flipY = false;
      texture.encoding = THREE.sRGBEncoding;
      texture.needsUpdate = true;
      targetMesh.material.map = texture;
      targetMesh.material.needsUpdate = true;
    }

    initCanvas(); // первоначальная инициализация

    init();
    function init() {
      // Сцена и камера
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

      // Рендерер с AR
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.getElementById('ar-container').appendChild(renderer.domElement);
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // Источник управления
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);

      // Ретикл для размещения
      const geometry = new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI/2);
      const material = new THREE.MeshBasicMaterial({ color: 0x007AFF });
      reticle = new THREE.Mesh(geometry, material);
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // Загрузка модели ручки
      const loader = new THREE.GLTFLoader();
      loader.load('models/PEN.glb', (gltf) => {
        penModel = gltf.scene;
        penModel.visible = false;
        penModel.traverse((child) => {
          if (child.isMesh) {
            targetMesh = child;
          }
        });
        scene.add(penModel);
      });

      // Обработка загрузки логотипа
      document.getElementById('logo-upload').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type === 'image/png') {
          const reader = new FileReader();
          reader.onload = (e) => {
            logoImg = new Image();
            logoImg.src = e.target.result;
            logoImg.onload = () => {
              initCanvas();
              updateTexture();
            };
          };
          reader.readAsDataURL(file);
        } else {
          alert('Пожалуйста, выберите файл PNG.');
        }
      });

      // Смена цвета корпуса
      document.getElementById('color-picker').addEventListener('change', (e) => {
        baseColor = e.target.value;
        initCanvas();
        updateTexture();
      });

      // Обработка hit-test
      renderer.xr.addEventListener('sessionstart', () => {
        const session = renderer.xr.getSession();
        session.requestReferenceSpace('viewer').then((refSpace) => {
          session.requestHitTestSource({ space: refSpace }).then((source) => {
            renderer.setAnimationLoop((timestamp, frame) => {
              if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const hitTestResults = frame.getHitTestResults(source);
                if (hitTestResults.length) {
                  const hit = hitTestResults[0];
                  const pose = hit.getPose(referenceSpace);
                  reticle.visible = true;
                  reticle.matrix.fromArray(pose.transform.matrix);
                } else {
                  reticle.visible = false;
                }
              }
              renderer.render(scene, camera);
            });
          });
        });
      });

      window.addEventListener('resize', onWindowResize);
    }

    function onSelect() {
      if (reticle.visible && penModel) {
        penModel.position.setFromMatrixPosition(reticle.matrix);
        penModel.visible = true;
        updateTexture();
      }
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
  </script>
</body>
</html>